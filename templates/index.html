<!DOCTYPE html>
<html>
<head>
    <title>HDHomeRun DVR</title>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin: 20px 0; }
        .day { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .selected { background-color: #4CAF50; color: white; }
        .channel-select { margin: 20px 0; }
        .time-select { margin: 20px 0; }
        .recordings { margin-top: 40px; }
        .recording { padding: 10px; border: 1fr solid #ddd; margin: 10px 0; }
        button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .tab { margin-bottom: 20px; }
        .tabs button { padding: 8px 16px; margin-right: 10px; }
        .content { display: none; }
        .content.active { display: block; }
        .program-guide table { width: 100%; border-collapse: collapse; }
        .program-guide th, .program-guide td { border: 1px solid #ddd; padding: 8px; text-align: left; }

        .download-button {
             display: inline-block;
             padding: 8px 16px;
             background-color: #2196F3;
             color: white;
             text-decoration: none;
             border-radius: 4px;
             margin-right: 10px;
             border: none;
             cursor: pointer;
             font-family: inherit;
             font-size: inherit;
         }

         .download-button:hover {
             background-color: #0b7dda;
         }

        /* Add margin-bottom to calendar-controls for spacing */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Space between controls and calendar */
        }
    </style>
</head>
<body>
    <h1>HDHomeRun DVR</h1>

    <!-- Tabs -->
    <div class="tab">
        <button onclick="showTab('schedule')">Schedule Recording</button>
        <button onclick="showTab('recordings')">Recordings</button>
        <button onclick="showTab('programGuide')">Program Guide</button>
    </div>


    <!-- Schedule tab content -->
    <div id="schedule" class="content active">
        <div class="calendar-controls">
            <button onclick="previousMonth()">Previous</button>
            <span id="month-year">Month Year</span>
            <button onclick="nextMonth()">Next</button>
        </div>
        <div class="calendar">
            <div class="day header">Sun</div>
            <div class="day header">Mon</div>
            <div class="day header">Tue</div>
            <div class="day header">Wed</div>
            <div class="day header">Thu</div>
            <div class="day header">Fri</div>
            <div class="day header">Sat</div>
        </div>
        <div class="channel-select">
            <label for="channel">Select Channel:</label>
            <select id="channel">
                <option value="">-- Select Channel --</option>
            </select>
        </div>
        <div class="time-select">
            <label for="startTime">Start Time:</label>
            <input type="time" id="startTime">
            <label for="duration">Duration (minutes):</label>
            <input type="number" id="duration" min="1" max="1440" value="60">
            <button onclick="scheduleRecording()">Schedule Recording</button>
        </div>
    </div>

    <!-- Recordings tab content -->
    <div id="recordings" class="content">
        <h2>Scheduled Recordings</h2>
        <div id="recordingsList"></div>
    </div>

    <!-- Program Guide tab content -->
    <div id="programGuide" class="content">
        <h2>Program Guide</h2>
        <label for="categoryFilter">Filter by category:</label>
        <select id="categoryFilter" onchange="filterPrograms()">
            <option value="">All</option>
            <option value="movie">Movie</option>
            <option value="news">News</option>
            <option value="sports">Sports</option>
        </select>
        <div class="program-guide" id="programGuideList"></div>
    </div>

<script>
    let selectedDate = null;
    let channels = [];
    let startingDay = 0;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // Update the channel loading
    fetch('/api/channels')
        .then(response => response.json())
        .then(data => {
            const channelSelect = document.getElementById('channel');
            data.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.guideNumber;  // Use guideNumber as value
                option.textContent = `${channel.guideNumber} - ${channel.guideName}`;
                channelSelect.appendChild(option);
            });
        });

    // Generate calendar
    function generateCalendar() {
        const calendar = document.querySelector('.calendar');
        const monthYear = document.getElementById('month-year');

        // Clear existing days (except headers)
        const days = calendar.querySelectorAll('.day:not(.header)');
        days.forEach(day => day.remove());

        // Get first day of month
        const firstDay = new Date(currentYear, currentMonth, 1);
        startingDay = firstDay.getDay();

        // Get days in month
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // Update month/year display
        const monthNames = ["January", "February", "March", "April", "May", "June",
                            "July", "August", "September", "October", "November", "December"];
        monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

        // Add empty cells for days before the first day
        for (let i = 0; i < startingDay; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day empty';
            calendar.appendChild(dayDiv);
        }

        // Add days
        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            dayDiv.textContent = i;
            dayDiv.onclick = () => selectDate(currentYear, currentMonth + 1, i);
            calendar.appendChild(dayDiv);
        }
    }

    // Select date
    function selectDate(year, month, day) {
        // Remove previous selection
        const previouslySelected = document.querySelector('.day.selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('selected');
        }

        // Find the clicked day element
        const days = document.querySelectorAll('.day:not(.header):not(.empty)');
        let clickedDay = null;

        // Find the day that matches our year/month/day
        for (let d of days) {
            const dNum = parseInt(d.textContent);
            if (dNum === day) {
                clickedDay = d;
                break;
            }
        }

        if (clickedDay) {
            clickedDay.classList.add('selected');
            selectedDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
    }

    // Month navigation
    function previousMonth() {
        if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
        } else {
            currentMonth--;
        }
        generateCalendar();
    }

    function nextMonth() {
        if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
        } else {
            currentMonth++;
        }
        generateCalendar();
    }

    // Update the recording scheduling
    function scheduleRecording() {
        if (!selectedDate) {
            alert('Please select a date');
            return;
        }

        const channelId = document.getElementById('channel').value;
        const startTime = document.getElementById('startTime').value;
        const duration = document.getElementById('duration').value;

        if (!channelId || !startTime || !duration) {
            alert('Please fill in all fields');
            return;
        }

        fetch('/api/recordings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                channelId: channelId,
                date: selectedDate,
                startTime: startTime,
                duration: parseInt(duration)
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            alert('Recording scheduled!');
            loadRecordings();
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.error) {
                alert(error.error);
            } else {
                alert('Error scheduling recording');
            }
        });
    }

   function loadRecordings() {
        fetch('/api/recordings')
            .then(response => response.json())
            .then(data => {
                const recordingsList = document.getElementById('recordingsList');
                recordingsList.innerHTML = '';
                data.forEach(recording => {
                    const channelName = recording.guide_number ?
                        `${recording.guide_number} - ${recording.guide_name}` :
                        recording.channel_id;

                    const div = document.createElement('div');
                    div.className = 'recording';
                    div.innerHTML = `
                        <strong>${recording.date} ${recording.start_time}</strong>
                        <br>
                        Title : ${recording.title}
                        <br>
                        Duration: ${recording.duration} minutes
                        <br>
                        Channel: ${channelName}
                        <br>
                        Status: ${recording.status}
                        ${recording.status === 'completed' ?
                           `<a href="/api/recordings/${recording.id}/file" class="download-button" target="_blank">Download</a>` :
                        ''}

                        <button onclick="deleteRecording(${recording.id})">Delete</button>
                    `;
                    recordingsList.appendChild(div);
                });
            });
    }

    // Add this new function to handle downloading recordings
    function downloadRecording(id) {
        window.location.href = `/api/recordings/${id}/file`;
    }

    // Delete recording
    function deleteRecording(id) {
        fetch(`/api/recordings/${id}`, {
            method: 'DELETE'
        })
        .then(() => {
            loadRecordings();
        });
    }

   // Tab switching functions
    function showTab(tabId) {
        document.querySelectorAll('.content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');

        if (tabId === 'programGuide') {
            loadPrograms();
        }
    }

    function loadPrograms() {
        fetch('/api/guide')
            .then(response => response.json())
            .then(data => {
                const programGuideList = document.getElementById('programGuideList');
                programGuideList.innerHTML = '';

                if (data.programs && Array.isArray(data.programs)) {
                    // Create table
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Title</th>
                                <th>Start Time</th>
                                <th>Duration (min)</th>
                                <th>Category</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="programsBody">
                        </tbody>
                    `;
                    programGuideList.appendChild(table);

                    function getLocalTimeStringNoTZ(date) {
                      const month = date.getMonth().toString() + 1;
                      const day = date.getDate().toString().padStart(2, '0');
                      const hours = date.getHours().toString().padStart(2, '0');
                      const minutes = date.getMinutes().toString().padStart(2, '0');
                      return `${month}/${day} ${hours}:${minutes}`;
                    }

                    // Populate table with programs
                    const programsBody = document.getElementById('programsBody');
                    data.programs.forEach(program => {
                        // Format the start time
                        let startTime = new Date(program.start);
                        let formattedStartTime = `${getLocalTimeStringNoTZ(startTime)}`;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${program.channel}</td>
                            <td>${program.title} ${program.subtitle ? ` - ${program.subtitle}` : ''}</td>
                            <td>${formattedStartTime}</td>
                            <td>${program.duration || 'N/A'}</td>
                            <td>${program.category || 'N/A'}</td>
                        `;
                        const actionCell = document.createElement('td');
                        const scheduleButton = document.createElement('button');
                        scheduleButton.textContent = 'Schedule';
                        scheduleButton.onclick = () => scheduleProgramRecording(program);
                        actionCell.appendChild(scheduleButton);
                        row.appendChild(actionCell);

                        programsBody.appendChild(row);
                    });
                } else {
                    programGuideList.textContent = 'No programs available';
                }
            });
    }

    function scheduleProgramRecording(program) {
        let dateObj = new Date(program.start);
        let formattedDate = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getDate().toString().padStart(2,'0')}`
        let startTime = `${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}`
 
        fetch('/api/recordings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                channelId: program.channel,
                date: formattedDate,  // Use properly formatted date
                startTime: startTime,
                duration: program.duration,
                title: program.title
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            alert('Recording scheduled!');
            loadRecordings();
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.error) {
                alert(error.error);
            } else {
                alert('Error scheduling recording');
            }
        });
    }

    // Filter programs by category
    function filterPrograms() {
        const selectedCategory = document.getElementById('categoryFilter').value;
        fetch('/api/guide')
            .then(response => response.json())
            .then(data => {
                if (data.programs && Array.isArray(data.programs)) {
                    const filteredPrograms = data.programs.filter(program =>
                        !selectedCategory || program.category === selectedCategory
                    );
                    renderProgramTable(filteredPrograms);
                }
            });
    }

    // Render programs table
    function renderProgramTable(programs) {
        const programGuideList = document.getElementById('programGuideList');
        programGuideList.innerHTML = '';

        if (programs.length > 0) {
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Channel</th>
                        <th>Title</th>
                        <th>Start Time</th>
                        <th>Duration (min)</th>
                        <th>Category</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="programsBody">
                </tbody>
            `;
            programGuideList.appendChild(table);

            const programsBody = document.getElementById('programsBody');
            programs.forEach(program => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${program.channel}</td>
                    <td>${program.title} ${program.subtitle ? ` - ${program.subtitle}` : ''}</td>
                    <td>${program.start}</td>
                    <td>${program.duration || 'N/A'}</td>
                    <td>${program.category || 'N/A'}</td>
                `;
                const actionCell = document.createElement('td');
                const scheduleButton = document.createElement('button');
                scheduleButton.textContent = 'Schedule';
                scheduleButton.onclick = () => scheduleProgramRecording(program);
                actionCell.appendChild(scheduleButton);
                row.appendChild(actionCell);

                programsBody.appendChild(row);
            });
        } else {
            programGuideList.textContent = 'No matching programs found';
        }
    }

    // Initialize
    generateCalendar();
    loadRecordings();

    // Load program guide when tab is shown
    showTab('schedule');  // Default to schedule tab on page load
</script>

</body>
</html>
